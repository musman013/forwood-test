{"_index":"2000000001.1000000001","_type":"_doc","_id":"2000000001.0443429762.2000000001.TipoDefinition.ActionPlan","_version":819,"_score":1,"_source":{"___commit_number___":"d01b09ec-f5ab-451b-bbc9-fba382ee1e1d","tipo_id":"ActionPlan","application":"0443429762","tipo_meta":{"display_name":"ActionPlan","tipo_type_labels":["Simple Tipo"],"tipo_type":["entity"],"tipo_type_copy_labels":"Simple Tipo","tipo_type_copy":"entity","tipo_name":"ActionPlan","description":"Action Plan... - up3","pre_load":true,"hide_create":true,"hide_heading":false,"desktop_max_columns":"4","tablet_max_columns":"2","mobile_max_columns":"1","grid_max_columns":"13","hide_actions":false},"tipo_fields":[{"sequence":1,"display_name___token":"TT___GO_TO_PARENT","display_name":"Go To Parent","field_type_labels":"Action","field_type":"action","list_display":false,"field_name":"goto_parent","show_question_no":true,"true_alternate_label_str":"Yes","false_alternate_label_str":"No","read_only":true,"short_display":true,"disable_expansion":true,"element_style":"{'margin':'10px'}","hidden_":false,"hidden_label":true,"hidden_hyperlink":true,"visibility_expression":"$tipo_handle.menu_item.tipo_name === 'ActionPlan'","relationship_type":"reference","action_settings_":{"javascript_code":"console.log(data_handle);\r\n\r\nif(data_handle.tipo.parent_tipo_id && data_handle.tipo.parent_tipo_name) {\r\n    tipoHandle.toTipo('view', data_handle.tipo.parent_tipo_name, data_handle.tipo.parent_tipo_id);\r\n}\r\nelse {\r\n    tipoHandle.toTipo('view', data_handle.tipo.verification_tipo_id_labels, data_handle.tipo.verification_tipo_id);\r\n}\r\nreturn true;"},"_ARRAY_META":{"_HASH":"6687269714"}},{"sequence":2,"display_name___token":"TT___COMPLETE_ACTION","display_name":"Complete Action","field_type_labels":"Action","field_type":"action","field_name":"complete_action","show_question_no":true,"true_alternate_label_str":"Yes","false_alternate_label_str":"No","short_display":true,"disable_expansion":true,"element_style":"{'margin':'10px 10px 10px 0'}","hidden_label":true,"hidden_hyperlink":true,"hide_in_create":true,"hide_in_edit":true,"visibility_expression":"$tipo.status_ap___token != 'TT___COMPLETE' && ($tipo_handle.user_meta.role.endsWith('SiteAdmin') || ($tipo_handle.user_meta.email === $tipo.responsible_person_))","relationship_type":"reference","action_settings_":{"javascript_code":"// function htmlencode(str) {\n//     var buf = [];\n//     for (var i = str.length - 1; i >= 0; i--) {\n//         buf.unshift(['&#', str[i].charCodeAt(), ';'].join(''));\n//     }\n//     return buf.join('');\n// }\nconst now = new Date(tipoHandle.getDateUtil().utc().format()).toISOString();\nconst time = tipoHandle.getDateUtil().utc().format('HH.mm.sss');\nconst timearray = time.split('.');\nconst dtnumber = (+timearray[0] * 3600) + (+timearray[1] * 60);\ndata_handle.tipo.complete_date = now;\ndata_handle.tipo.complete_date_dtnumber = dtnumber;\ndata_handle.tipo.completeactionbuttonclick = true;\nif (tipoHandle.user_meta.user_attributes.user.locale === 'en') {\n    data_handle.tipo.status_ap = 'Complete';\n} else {\n    data_handle.tipo.status_ap = 'Πλήρης';\n}\ndata_handle.tipo.status_ap___token = 'TT___COMPLETE';\ntipoHandle.updateTipo('ActionPlan', data_handle.tipo.tipo_id, data_handle.tipo).then((res) => {\n    if (res) {\n        setTimeout(() => {\n            tipoHandle.showMessage(tipoHandle.getInstantTranslation('TT___ACTION_COMPLETED'), '');\n            data_handle.formControl.get('status_ap___token').setValue('TT___COMPLETE');\n            if (tipoHandle.user_meta.user_attributes.user.locale === 'en') {\n                data_handle.formControl.get('status_ap').setValue('Complete');\n            } else {\n                data_handle.formControl.get('status_ap').setValue('Πλήρης');\n            }\n            tipoHandle.getTipo('ActionPlan', data_handle.tipo.tipo_id);\n        }, 1000);\n    }\n});\n\n\n\n// if (tipoHandle.tipoInternalHandleService.isOnline) {\n    if (data_handle.tipo.parent_tipo_name === 'CreateIncident') {\n        tipoHandle.getTipo(data_handle.tipo.parent_tipo_name, data_handle.tipo.parent_tipo_id).then((result) => {\n            if (result.incident_action.length > 0) {\n                let action_ids = _.map(result.incident_action, 'action_plan');\n                let query_params = { tipo_filter: `tipo_id:${action_ids.join(' OR ')}` }\n                tipoHandle.getTipos('ActionPlan', query_params, true).then((res) => {\n                    result.overview_total_actions = result.incident_action.length;\n                    let actionPlans = res.filter(item => result.incident_action.some(itemToBeRemoved => itemToBeRemoved.action_plan === item.tipo_id))\n                    result.overview_outstanding_actions = actionPlans.filter(t => t && t.status_ap___token === 'TT___INCOMPLETE').length;\n                    result.completed_actions = result.overview_total_actions - result.overview_outstanding_actions;;\n                    tipoHandle.updateTipo(result.tipo_name, result.tipo_id, result);\n                })\n            }\n        })\n    }\n\n    if (data_handle.tipo.parent_tipo_name === 'Meeting') {\n        tipoHandle.getTipo(data_handle.tipo.parent_tipo_name, data_handle.tipo.parent_tipo_id).then((result) => {\n            if (result.incident_action.length > 0) {\n                let action_ids = _.map(result.incident_action, 'action_plan');\n                let query_params = { tipo_filter: `tipo_id:${action_ids.join(' OR ')}` }\n                tipoHandle.getTipos('ActionPlan', query_params, true).then((res) => {\n                    result.safety_meetings.meeting_total_actions = result.incident_action.length;\n                    let actionPlans = res.filter(item => result.incident_action.some(itemToBeRemoved => itemToBeRemoved.action_plan === item.tipo_id))\n                    result.safety_meetings.meeting_outstanding_actions = actionPlans.filter(t => t && t.status_ap___token === 'TT___INCOMPLETE').length;\n                    result.safety_meetings.meeting_completed_actions = actionPlans.filter(t => t && t.status_ap___token === 'TT___COMPLETE').length;\n                    tipoHandle.updateTipo(result.tipo_name, result.tipo_id, result);\n                })\n            }\n        })\n    }\n\n    if (data_handle.tipo.parent_tipo_name === 'SafetyConversations') {\n        tipoHandle.getTipo(data_handle.tipo.parent_tipo_name, data_handle.tipo.parent_tipo_id).then((result) => {\n            if (result.incident_action.length > 0) {\n                let action_ids = _.map(result.incident_action, 'action_plan');\n                let query_params = { tipo_filter: `tipo_id:${action_ids.join(' OR ')}` }\n                tipoHandle.getTipos('ActionPlan', query_params, true).then((res) => {\n                    result.safety_conversations.conversation_total_actions = result.incident_action.length;\n                    let actionPlans = res.filter(item => result.incident_action.some(itemToBeRemoved => itemToBeRemoved.action_plan === item.tipo_id))\n                    result.safety_conversations.conversation_outstanding_actions = actionPlans.filter(t => t && t.status_ap___token === 'TT___INCOMPLETE').length;\n                    result.safety_conversations.conversation_completed_actions = actionPlans.filter(t => t && t.status_ap___token === 'TT___COMPLETE').length;\n                    tipoHandle.updateTipo(result.tipo_name, result.tipo_id, result);\n                })\n            }\n        })\n    }\n\n// }\nreturn true;"},"_ARRAY_META":{"_HASH":"8478993739"}},{"sequence":3,"display_name___token":"TT___ACTION_PLAN_ID","display_name":"Action Plan ID","field_type_labels":"string","field_type":"string","list_display":false,"field_name":"tipo_id","read_only":true,"desktop_width":"100","tablet_width":"100","mobile_width":"100","hidden_":false,"hide_in_create":true,"_ARRAY_META":{"_HASH":"6566143371"}},{"sequence":4,"display_name___token":"TT___ACTION_CLASS","display_name":"Action Class","field_type_labels":"Text","field_type":"string","list_display":true,"field_name":"action_class","show_as_filter":false,"enable_multilanguage_input":true,"dd_field":true,"multiple_choice":false,"allowed_values___token":["TT___TASK","TT___FIXED_IN_FIELD"],"allowed_values":["Task","Fixed in Field"],"allowed_values_with_colour":[{"sequence":1,"value":"Task","colour":"#656565","_ARRAY_META":{"_HASH":"7966893337"}},{"sequence":2,"value":"Fixed in Field","colour":"#002A74","_ARRAY_META":{"_HASH":"5940825306"}}],"form_text":false,"default_value___token":"TT___TASK","default_value":"Task","read_only_in_edit":true,"short_display":true,"disable_expansion":true,"mandatory":true,"relationship_type":"reference","tipo_field_event_js":[{"event_name":"OnChange (data_handle)","javascript_code":"data_handle.tipo.verification_tipo_id_labels = tipoHandle.tipoInternalHandleService.getCurrentState().tipo_name;\ndata_handle.formControl.get('verification_tipo_id_labels').setValue(tipoHandle.tipoInternalHandleService.getCurrentState().tipo_name);\ndata_handle.tipo.verification_tipo_id = tipoHandle.tipoInternalHandleService.getCurrentState().tipo_id;\ndata_handle.formControl.get('verification_tipo_id').setValue(tipoHandle.tipoInternalHandleService.getCurrentState().tipo_id);\n\nif(data_handle.tipo.action_class___token === 'TT___FIXED_IN_FIELD') {\n    data_handle.tipo.status_ap___token = 'TT___COMPLETE';\n    data_handle.tipo.status_ap = (tipoHandle.user_meta.user_attributes.user.locale === 'en') ? 'Complete' : 'Πλήρης';\n    data_handle.formControl.get('status_ap___token').setValue('TT___COMPLETE');\n    data_handle.tipo.complete_date = new Date(tipoHandle.getDateUtil().utc().format()).toISOString();\n} else{\n    data_handle.tipo.status_ap___token = 'TT___INCOMPLETE';\n    data_handle.tipo.status_ap = (tipoHandle.user_meta.user_attributes.user.locale === 'en') ? 'Incomplete' : 'Ατελής';\n    data_handle.formControl.get('status_ap___token').setValue('TT___INCOMPLETE');\n    data_handle.formControl.get('status_ap').setValue('Incomplete');\n}","_ARRAY_META":{"_HASH":"2950336789"}}],"_ARRAY_META":{"_HASH":"5532848371"}},{"sequence":5,"display_name___token":"TT___ACTION_PLAN_TYPE","display_name":"Action Plan Type","field_type_labels":"Text","field_type":"string","list_display":false,"field_name":"action_plan_type","show_as_filter":false,"enable_multilanguage_input":true,"dd_field":true,"multiple_choice":false,"allowed_values___token":["TT___BEHAVIOURAL","TT___SYSTEM_OR_PROCESS","TT___PLANT_OR_EQUIPMENT"],"allowed_values":["Behavioural","System or Process","Plant or Equipment"],"allowed_values_with_colour":[{"value":"Plant or Equipment","colour":"#656565","_ARRAY_META":{"_HASH":"2039714264"}},{"value":"Behavioural","colour":"#656565","_ARRAY_META":{"_HASH":"3558689615"}},{"value":"System or Process","colour":"#656565","_ARRAY_META":{"_HASH":"4432211198"}}],"short_display":true,"disable_expansion":true,"desktop_width":"50","tablet_width":"50","mobile_width":"100","mandatory":true,"relationship_type":"reference","_ARRAY_META":{"_HASH":"5510499420"}},{"sequence":5,"display_name___token":"TT___CREATED_BY","display_name":"Created by","field_type_labels":"Text","field_type":"string","list_display":false,"field_name":"created_by_labels","read_only":true,"disable_expansion":true,"hidden_":true,"hide_in_create":true,"hide_in_edit":true,"relationship_type":"reference","_ARRAY_META":{"_HASH":"5568617666"}},{"sequence":6,"display_name___token":"TT___PRIORITY","display_name":"Priority","field_type_labels":"Text","field_type":"string","list_display":true,"field_name":"priority","show_as_filter":false,"enable_multilanguage_input":true,"dd_field":true,"multiple_choice":false,"allowed_values___token":["TT___URGENT_88","TT___HIGH_64","TT___MEDIUM_19","TT___LOW_91"],"allowed_values_with_colour":[{"value":"Plant or Equipment","colour":"#656565","_ARRAY_META":{"_HASH":"2039714264"}},{"value":"Behavioural","colour":"#656565","_ARRAY_META":{"_HASH":"3558689615"}},{"value":"System or Process","colour":"#656565","_ARRAY_META":{"_HASH":"4432211198"}}],"short_display":true,"disable_expansion":true,"hide_in_view":false,"visibility_expression":"$tipo.action_class___token === 'TT___TASK'","mandatory":true,"relationship_type":"reference","_ARRAY_META":{"_HASH":"9515011069"}},{"sequence":6,"display_name___token":"TT___PRIORITY","display_name":"Priority","field_type_labels":"Text","field_type":"string","list_display":false,"field_name":"priority___token","show_as_filter":true,"enable_multilanguage_input":false,"dd_field":false,"multiple_choice":false,"allowed_values":["Urgent","Medium","High","Low"],"allowed_values_with_colour":[{"value":"Plant or Equipment","colour":"#656565","_ARRAY_META":{"_HASH":"2039714264"}},{"value":"Behavioural","colour":"#656565","_ARRAY_META":{"_HASH":"3558689615"}},{"value":"System or Process","colour":"#656565","_ARRAY_META":{"_HASH":"4432211198"}}],"short_display":true,"disable_expansion":true,"hidden_":true,"hidden_label":false,"hide_in_create":false,"hide_in_edit":false,"hide_in_view":false,"relationship_type":"reference","_ARRAY_META":{"_HASH":"0066720297"}},{"sequence":7,"display_name___token":"TT___REVIEW","display_name":"Review","field_type_labels":"True/False","field_type":"boolean","field_name":"review","show_question_no":true,"enable_multilanguage_input":false,"true_alternate_label_str___token":"TT___YES","true_alternate_label_str":"Yes","false_alternate_label_str___token":"TT___NO","false_alternate_label_str":"No","default_value":false,"short_display":true,"disable_expansion":true,"hidden_hyperlink":true,"visibility_expression":"!$tipo.reviewtoggle","relationship_type":"reference","tipo_field_event_js":[{"event_name":"OnChange (data_handle)","javascript_code":"if(data_handle.tipo.review) {\n    let currentdate = new Date();\n    currentdate.setDate(currentdate.getDate() + 28);\n    let newdate = currentdate.toISOString()\n    data_handle.tipo.review_date = newdate;\n    data_handle.formControl.get('review_date').setValue(newdate);\n}","_ARRAY_META":{"_HASH":"2572714356"}}],"_ARRAY_META":{"_HASH":"1587382106"}},{"sequence":7,"display_name___token":"TT___REVIEW","display_name":"Review","field_type_labels":"True/False","field_type":"boolean","field_name":"review_fixed","show_question_no":true,"enable_multilanguage_input":false,"true_alternate_label_str___token":"TT___YES","true_alternate_label_str":"Yes","false_alternate_label_str___token":"TT___NO","false_alternate_label_str":"No","default_value":true,"read_only":true,"short_display":true,"disable_expansion":true,"hidden_hyperlink":true,"hide_in_create":false,"hide_in_edit":false,"visibility_expression":"$tipo.reviewtoggle","relationship_type":"reference","_ARRAY_META":{"_HASH":"3185197222"}},{"sequence":8,"display_name___token":"TT___COMMENT","display_name":"Comment","field_type_labels":"Multiline Text","field_type":"longstring","list_display":false,"field_name":"comment","field_description___token":"TT___DESCRIPTION_OF_NON_COMPLIANCE_WITH_LEGIS","field_description":"Non-compliance description or information to be added","disable_expansion":true,"desktop_width":"100","tablet_width":"100","mobile_width":"100","mandatory":false,"relationship_type":"reference","_ARRAY_META":{"_HASH":"7931621032"}},{"sequence":9,"display_name___token":"TT___ACTIVITY","display_name":"Activity","field_type_labels":"Multiline Text","field_type":"longstring","list_display":true,"field_name":"action_activity","field_description___token":"TT___WHAT_NEEDS_TO_BE_DONE_OR_WHAT_HAS_BEEN_D","field_description":"What needs to / was done to rectify the non-compliance","disable_expansion":true,"desktop_width":"100","tablet_width":"100","mobile_width":"100","mandatory":true,"relationship_type":"reference","_ARRAY_META":{"_HASH":"7649476636"}},{"sequence":10,"display_name___token":"TT___IMPLEMENTATION_DETAILS","display_name":"Szczegóły dotyczące wdrożenia","field_type_labels":"Text","field_type":"string","field_name":"implementation_details","show_question_no":true,"true_alternate_label_str":"Yes","false_alternate_label_str":"No","short_display":true,"disable_expansion":true,"desktop_width":"100","tablet_width":"100","mobile_width":"100","hidden_hyperlink":true,"relationship_type":"reference","_ARRAY_META":{"_HASH":"2564263777"}},{"sequence":11,"display_name___token":"TT___START_DATE","display_name":"Start Date","field_type_labels":"Date/Time","field_type":"date_time","list_display":true,"field_name":"ap_start_date","only_date":true,"default_value_dtnumber":6180,"read_only":false,"short_display":true,"disable_expansion":true,"visibility_expression":"$tipo.action_class___token === 'TT___TASK'","mandatory":true,"relationship_type":"reference","expression_labels":"Current Date","eval_on_edit":false,"_ARRAY_META":{"_HASH":"1143510542"}},{"sequence":12,"display_name___token":"TT___END_DATE_17","display_name":"End Date","field_type_labels":"Date/Time","field_type":"date_time","list_display":false,"field_name":"end_date","only_date":true,"short_display":true,"disable_expansion":true,"hide_in_create":false,"hide_in_edit":false,"hide_in_view":false,"visibility_expression":"$tipo.action_class___token === 'TT___TASK'","mandatory":true,"relationship_type":"reference","expression_labels":"Current Date","_ARRAY_META":{"_HASH":"1905878917"}},{"sequence":12,"display_name___token":"TT___END_DATE_18","display_name":"End Date","field_type_labels":"Date/Time","field_type":"date_time","list_display":true,"field_name":"end_date","show_as_filter":false,"only_date":true,"short_display":true,"disable_expansion":true,"hidden_label":false,"hide_in_create":true,"hide_in_edit":true,"hide_in_view":true,"mandatory":true,"relationship_type":"reference","expression_labels":"Current Date","_ARRAY_META":{"_HASH":"4148000375"}},{"sequence":12,"display_name___token":"TT___END_DATE_PLEASE_SELECT_DATE_RANGE","display_name":"End Date (Please Select Date Range)","field_type_labels":"Date/Time","field_type":"date_time","list_display":false,"field_name":"end_date","show_as_filter":true,"only_date":true,"short_display":true,"disable_expansion":true,"hidden_label":false,"hide_in_create":true,"hide_in_edit":true,"hide_in_view":true,"mandatory":true,"relationship_type":"reference","expression_labels":"Current Date","_ARRAY_META":{"_HASH":"5442782204"}},{"sequence":12.2,"display_name___token":"TT___CREATED_DATE","display_name":"Created Date","field_type_labels":"Date/Time","field_type":"date_time","list_display":true,"field_name":"created_date","show_question_no":true,"date_format":"F j, Y,  h:i K","true_alternate_label_str":"Yes","false_alternate_label_str":"No","read_only":true,"short_display":true,"disable_expansion":true,"hidden_":false,"hidden_hyperlink":true,"hide_in_create":true,"hide_in_edit":true,"hide_in_view":true,"relationship_type":"reference","_ARRAY_META":{"_HASH":"9414333142"}},{"sequence":12.2,"display_name___token":"TT___CREATED_DATE_PLEASE_SELECT_DATE_RANGE","display_name":"Created Date (Please Select Date Range)","field_type_labels":"Date/Time","field_type":"date_time","field_name":"created_date","show_question_no":true,"show_as_filter":true,"date_format":"F j, Y,  h:i K","true_alternate_label_str":"Yes","false_alternate_label_str":"No","read_only":true,"short_display":true,"disable_expansion":true,"hidden_":true,"hidden_hyperlink":true,"hide_in_create":false,"hide_in_edit":false,"hide_in_view":false,"relationship_type":"reference","_ARRAY_META":{"_HASH":"7157244193"}},{"sequence":13,"display_name___token":"TT___RESPONSIBLE_PERSON_99","display_name":"Responsible Person","field_type_labels":"TipoFIDUser","field_type":"Tipo.TipoFIDUser","list_display":false,"field_name":"responsible_person_","show_as_filter":false,"tipo_array":false,"dd_field":true,"read_only_in_edit":true,"short_display":true,"disable_expansion":true,"hidden_hyperlink":true,"visibility_expression":"$tipo.action_class___token === 'TT___TASK'","mandatory":true,"relationship_type":"reference","select_label_field_labels":"Display Name","select_label_field":"displayName","select_key_field_labels":"Email","select_key_field":"email","popup_select":false,"query_params":[{"param_name":"tipo_fields","param_value":"status","_ARRAY_META":{"_HASH":"1519326416"}},{"param_name":"per_page","param_value":"5000","_ARRAY_META":{"_HASH":"5985356301"}},{"param_name":"tipo_action","param_value":"true","_ARRAY_META":{"_HASH":"9525667923"}}],"expression_labels":"Current Date","_ARRAY_META":{"_HASH":"4137256062"}},{"sequence":13,"display_name___token":"TT___RESPONSIBLE_PERSON_99","display_name":"Responsible Person","field_type_labels":"TipoFIDUser","field_type":"Tipo.TipoFIDUser","list_display":true,"field_name":"responsible_person_","show_as_filter":false,"tipo_array":false,"dd_field":true,"short_display":true,"disable_expansion":true,"hidden_":false,"hidden_label":false,"hidden_hyperlink":true,"hide_in_create":true,"hide_in_edit":true,"hide_in_view":true,"mandatory":false,"relationship_type":"reference","select_label_field_labels":"Display Name","select_label_field":"displayName","select_key_field_labels":"Email","select_key_field":"email","popup_select":false,"query_params":[{"param_name":"tipo_action","param_value":"true","_ARRAY_META":{"_HASH":"3570123676"}},{"param_name":"per_page","param_value":"5000","_ARRAY_META":{"_HASH":"6919993134"}},{"param_name":"tipo_fields","param_value":"status","_ARRAY_META":{"_HASH":"7665367055"}}],"expression_labels":"Current Date","_ARRAY_META":{"_HASH":"6324508313"}},{"sequence":13,"display_name___token":"TT___RESPONSIBLE_PERSON_99","display_name":"Responsible Person","field_type_labels":"Text","field_type":"string","list_display":false,"field_name":"responsible_person__labels","show_as_filter":true,"tipo_array":false,"dd_field":true,"short_display":true,"disable_expansion":true,"hidden_":false,"hidden_label":false,"hidden_hyperlink":true,"hide_in_create":true,"hide_in_edit":true,"hide_in_view":true,"mandatory":false,"relationship_type":"reference","relationship_filter":"status:ACTIVE","select_label_field_labels":"Display Name","select_label_field":"displayName","select_key_field_labels":"Email","select_key_field":"email","popup_select":false,"expression_labels":"Current Date","_ARRAY_META":{"_HASH":"0736118885"}},{"sequence":14,"display_name___token":"TT___NOTIFY_RESPONSIBLE_PERSON_83","display_name":"Notify Responsible Person","field_type_labels":"True/False","field_type":"boolean","field_name":"notify_responsible_person","show_question_no":true,"field_description___token":"TT___WHEN_SET_TO_YES_A_NOTIFICATION_WILL_BE_S_27","field_description":"When set to 'Yes' a notification will be sent to the selected Responsible person","true_alternate_label_str___token":"TT___YES","true_alternate_label_str":"Yes","false_alternate_label_str___token":"TT___NO","false_alternate_label_str":"No","default_value":true,"short_display":true,"disable_expansion":true,"hidden_hyperlink":true,"visibility_expression":"$tipo.action_class___token === 'TT___TASK'","relationship_type":"reference","_ARRAY_META":{"_HASH":"3041950428"}},{"sequence":15,"display_name___token":"TT___FORWOOD_LEVEL","display_name":"Forwood Level","field_type_labels":"Text","field_type":"string","field_name":"forwood_level_labels","show_question_no":true,"true_alternate_label_str":"Yes","false_alternate_label_str":"No","read_only":true,"short_display":true,"disable_expansion":true,"hidden_":true,"hidden_hyperlink":true,"hide_in_create":true,"relationship_type":"reference","transient":true,"eval_on_edit":false,"_ARRAY_META":{"_HASH":"0076968337"}},{"sequence":15,"display_name___token":"TT___ACTION_STATUS","display_name":"Action Status","field_type_labels":"Text","field_type":"string","list_display":true,"field_name":"status_ap","show_as_filter":false,"enable_multilanguage_input":true,"tipo_array":false,"dd_field":true,"multiple_choice":false,"allowed_values___token":["TT___INCOMPLETE","TT___COMPLETE"],"allowed_values":["Incomplete","Complete"],"allowed_values_with_colour":[{"sequence":1,"value___token":"TT___INCOMPLETE","value":"Incomplete","colour":"#FFA300","_ARRAY_META":{"_HASH":"0944350116"}},{"sequence":2,"value___token":"TT___COMPLETE","value":"Complete","colour":"#8BD48B","_ARRAY_META":{"_HASH":"0181098086"}}],"default_value___token":"TT___INCOMPLETE","default_value":"Incomplete","read_only":true,"short_display":true,"disable_expansion":true,"value_style":"($tipo.status_ap___token === 'TT___INCOMPLETE' && {'width': '90%' , 'background-color': 'orange', 'padding': '3px', 'color': 'white'}) ||($tipo.status_ap___token === 'TT___COMPLETE' && {'width': '90%' , 'background-color': '#3ecc8a','padding': '3px', 'color': 'white'})","hide_in_create":true,"hide_in_edit":true,"mandatory":false,"relationship_type":"reference","eval_on_edit":false,"_ARRAY_META":{"_HASH":"2545953460"}},{"sequence":16,"display_name___token":"TT___ACTION_REVIEWER","display_name":"Action Reviewer","field_type_labels":"TipoFIDUser","field_type":"Tipo.TipoFIDUser","field_name":"action_reviewer","show_question_no":true,"true_alternate_label_str":"Yes","false_alternate_label_str":"No","short_display":true,"disable_expansion":true,"hidden_hyperlink":true,"visibility_expression":"$tipo.review","mandatory":true,"relationship_type":"reference","select_label_field_labels":"Display Name","select_label_field":"displayName","select_key_field_labels":"Email","select_key_field":"email","query_params":[{"param_name":"per_page","param_value":"5000","_ARRAY_META":{"_HASH":"0888365798"}},{"param_name":"tipo_action","param_value":"true","_ARRAY_META":{"_HASH":"2952149190"}},{"param_name":"tipo_fields","param_value":"status","_ARRAY_META":{"_HASH":"9148317289"}}],"tipo_field_event_js":[{"event_name":"OnChange (data_handle)","javascript_code":"console.log('Action Reviewer')","_ARRAY_META":{"_HASH":"7854523360"}}],"_ARRAY_META":{"_HASH":"6689882963"}},{"sequence":16,"display_name___token":"TT___REVIEW_DATE","display_name":"Review Date","field_type_labels":"Date/Time","field_type":"date_time","field_name":"review_date","show_question_no":true,"only_date":true,"true_alternate_label_str":"Yes","false_alternate_label_str":"No","read_only":false,"short_display":true,"disable_expansion":true,"hidden_hyperlink":true,"visibility_expression":"$tipo.review","relationship_type":"reference","_ARRAY_META":{"_HASH":"9951036729"}},{"sequence":16,"display_name___token":"TT___REVIEW_DETAILS","display_name":"Review Details","field_type_labels":"Text","field_type":"string","field_name":"review_details","show_question_no":true,"true_alternate_label_str":"Yes","false_alternate_label_str":"No","short_display":true,"disable_expansion":true,"sizing":"2","hidden_hyperlink":true,"visibility_expression":"$tipo.review","relationship_type":"reference","_ARRAY_META":{"_HASH":"5213066118"}},{"sequence":17,"display_name___token":"TT___COMPANY","display_name":"Company","field_type_labels":"Text","field_type":"string","list_display":false,"field_name":"company_labels","show_question_no":true,"show_as_filter":false,"true_alternate_label_str":"Yes","false_alternate_label_str":"No","read_only":true,"short_display":true,"disable_expansion":true,"hidden_":true,"hidden_hyperlink":true,"hide_in_create":true,"relationship_type":"reference","transient":true,"eval_on_edit":false,"_ARRAY_META":{"_HASH":"1108818337"}},{"sequence":17,"display_name___token":"TT___SITE","display_name":"Site","field_type_labels":"Text","field_type":"string","list_display":false,"field_name":"site_labels","show_question_no":true,"show_as_filter":false,"true_alternate_label_str":"Yes","false_alternate_label_str":"No","read_only":true,"short_display":true,"disable_expansion":true,"hidden_":true,"hidden_hyperlink":true,"hide_in_create":true,"relationship_type":"reference","transient":true,"eval_on_edit":false,"_ARRAY_META":{"_HASH":"3899261435"}},{"sequence":17,"display_name___token":"TT___CLIENT","display_name":"Client","field_type_labels":"Text","field_type":"string","list_display":false,"field_name":"client_labels","show_question_no":true,"true_alternate_label_str":"Yes","false_alternate_label_str":"No","read_only":true,"short_display":true,"disable_expansion":true,"hidden_":true,"hidden_hyperlink":true,"hide_in_create":true,"relationship_type":"reference","transient":true,"eval_on_edit":false,"_ARRAY_META":{"_HASH":"9036838984"}},{"sequence":21,"display_name___token":"TT___FILE_UPLOAD","display_name":"File Upload","field_type_labels":"File","field_type":"file","field_name":"file_upload_","show_question_no":true,"tipo_array":true,"true_alternate_label_str":"Yes","false_alternate_label_str":"No","short_display":true,"disable_expansion":true,"desktop_width":"100","relationship_type":"reference","_ARRAY_META":{"_HASH":"9655759062"}},{"sequence":25,"display_name___token":"TT___VERIFICATION_TIPO_ID","display_name":"verification_tipo_id","field_type_labels":"Text","field_type":"string","field_name":"verification_tipo_id","show_question_no":true,"true_alternate_label_str":"Yes","false_alternate_label_str":"No","short_display":true,"disable_expansion":true,"hidden_":true,"hidden_hyperlink":true,"relationship_type":"reference","_ARRAY_META":{"_HASH":"6867688809"}},{"sequence":26,"display_name":"verification_tipo_id_labels","field_type_labels":"Text","field_type":"string","field_name":"verification_tipo_id_labels","show_question_no":true,"true_alternate_label_str":"Yes","false_alternate_label_str":"No","short_display":true,"disable_expansion":true,"hidden_":true,"hidden_hyperlink":true,"relationship_type":"reference","_ARRAY_META":{"_HASH":"2331551930"}},{"sequence":30,"display_name___token":"TT___ACTION_STATUS","display_name":"Action Status","field_type_labels":"Text","field_type":"string","field_name":"status_ap___token","show_question_no":true,"show_as_filter":true,"true_alternate_label_str":"Yes","false_alternate_label_str":"No","default_value":"TT___INCOMPLETE","short_display":true,"disable_expansion":true,"hidden_":true,"hidden_hyperlink":true,"relationship_type":"reference","_ARRAY_META":{"_HASH":"6127616848"}},{"sequence":32,"display_name":"hierarchy_key","field_type_labels":"Text","field_type":"string","field_name":"hierarchy_key","show_question_no":true,"true_alternate_label_str":"Yes","false_alternate_label_str":"No","short_display":true,"disable_expansion":true,"hidden_":true,"hidden_hyperlink":true,"relationship_type":"reference","_ARRAY_META":{"_HASH":"8335078853"}},{"sequence":39,"display_name":"ReviewToggle","field_type_labels":"True/False","field_type":"boolean","field_name":"reviewtoggle","show_question_no":true,"true_alternate_label_str___token":"TT___YES","true_alternate_label_str":"Yes","false_alternate_label_str___token":"TT___NO","false_alternate_label_str":"No","short_display":true,"disable_expansion":true,"hidden_":true,"hidden_hyperlink":true,"relationship_type":"reference","_ARRAY_META":{"_HASH":"3080010982"}},{"sequence":100,"display_name___token":"TT___REFERENCE_ID","display_name":"Reference ID","field_type_labels":"Text","field_type":"string","list_display":false,"field_name":"parent_tipo_id","show_question_no":true,"show_as_filter":false,"true_alternate_label_str":"Yes","false_alternate_label_str":"No","read_only":true,"short_display":true,"disable_expansion":true,"hidden_":true,"hidden_hyperlink":false,"visibility_expression":"$tipo_handle.menu_item.tipo_name === 'CVRMSActionPlan'","relationship_type":"reference","_ARRAY_META":{"_HASH":"2173513514"}},{"sequence":105,"display_name___token":"TT___REFERENCE_TYPE","display_name":"Reference Type","field_type_labels":"Text","field_type":"string","field_name":"parent_tipo_name","show_question_no":true,"true_alternate_label_str":"Yes","false_alternate_label_str":"No","read_only":true,"short_display":true,"disable_expansion":true,"hidden_":true,"hidden_hyperlink":true,"visibility_expression":"$tipo_handle.menu_item.tipo_name === 'CVRMSActionPlan'","relationship_type":"reference","_ARRAY_META":{"_HASH":"5854782162"}},{"sequence":120,"display_name___token":"TT___DATE_LAST_UPDATED","display_name":"Date Last Updated","field_type_labels":"Date/Time","field_type":"date_time","list_display":false,"field_name":"updated_date","only_date":true,"read_only":true,"short_display":true,"disable_expansion":true,"hidden_":false,"hide_in_create":true,"hide_in_edit":true,"hide_in_mobile":true,"hide_in_tablet":true,"visibility_expression":"$tipo_handle.menu_item.tipo_name === 'CreateIncident'","relationship_type":"reference","_ARRAY_META":{"_HASH":"4860311518"}},{"sequence":121,"display_name___token":"TT___LAST_UPDATED_BY","display_name":"Last Updated by","field_type_labels":"Text","field_type":"string","list_display":false,"field_name":"updated_by","only_date":true,"read_only":true,"short_display":true,"disable_expansion":true,"hidden_":false,"hide_in_create":true,"hide_in_edit":true,"hide_in_mobile":true,"hide_in_tablet":true,"visibility_expression":"$tipo_handle.menu_item.tipo_name === 'CreateIncident'","relationship_type":"reference","_ARRAY_META":{"_HASH":"5792972342"}},{"sequence":1001,"display_name___token":"TT___COMPLETED_DATE","display_name":"Completed Date","field_type_labels":"Date/Time","field_type":"date_time","list_display":false,"field_name":"complete_date","only_date":true,"short_display":true,"disable_expansion":true,"hidden_":true,"hide_in_create":false,"hide_in_edit":false,"hide_in_view":false,"mandatory":false,"relationship_type":"reference","expression_labels":"Current Date","_ARRAY_META":{"_HASH":"1490747347"}},{"sequence":1002,"display_name___token":"TT___ACTION_CLASS","display_name":"Action Class","field_type_labels":"Text","field_type":"string","field_name":"action_class___token","show_question_no":true,"show_as_filter":true,"true_alternate_label_str":"Yes","false_alternate_label_str":"No","default_value":"TT___TASK","short_display":true,"disable_expansion":true,"hidden_":true,"hidden_hyperlink":true,"relationship_type":"reference","_ARRAY_META":{"_HASH":"6591707228"}},{"sequence":1003,"display_name":"ActionCompletedEmailSent","field_type_labels":"Text","field_type":"string","field_name":"ActionCompletedEmailSent","show_question_no":true,"true_alternate_label_str":"Yes","false_alternate_label_str":"No","short_display":true,"disable_expansion":true,"hidden_":true,"hidden_hyperlink":true,"hide_in_create":true,"hide_in_edit":true,"hide_in_view":true,"relationship_type":"reference","_ARRAY_META":{"_HASH":"0398871838"}},{"sequence":1004,"display_name___token":"TT___SITE_40","display_name":"Region","field_type_labels":"Text","field_type":"string","field_name":"company_labels","show_question_no":true,"true_alternate_label_str":"Yes","false_alternate_label_str":"No","read_only":true,"short_display":true,"disable_expansion":true,"hidden_":true,"hidden_hyperlink":true,"relationship_type":"reference","_ARRAY_META":{"_HASH":"8147219146"}},{"sequence":1005,"display_name___token":"TT___AREA_26","display_name":"Area","field_type_labels":"Text","field_type":"string","field_name":"structure_level_1_labels","show_question_no":true,"true_alternate_label_str":"Yes","false_alternate_label_str":"No","read_only":true,"short_display":true,"disable_expansion":true,"hidden_":true,"hidden_hyperlink":true,"relationship_type":"reference","_ARRAY_META":{"_HASH":"9888185978"}},{"sequence":1006,"display_name___token":"TT___CONTRACTOR_COMPANY","display_name":"Contractor Company","field_type_labels":"Text","field_type":"string","field_name":"contractor_company","show_question_no":true,"true_alternate_label_str":"Yes","false_alternate_label_str":"No","read_only":true,"short_display":true,"disable_expansion":true,"hidden_":true,"hidden_hyperlink":true,"relationship_type":"reference","_ARRAY_META":{"_HASH":"3332263794"}},{"sequence":1007,"display_name":"Address details","field_type_labels":"Text","field_type":"string","field_name":"geo_locn","show_question_no":true,"true_alternate_label_str":"Yes","false_alternate_label_str":"No","read_only":true,"short_display":true,"disable_expansion":true,"hidden_":true,"hidden_hyperlink":true,"relationship_type":"reference","_ARRAY_META":{"_HASH":"9395703491"}},{"sequence":1008,"display_name":"Geo Location","field_type_labels":"geo_locn_locn","field_type":"FieldGroup.geo_locn_locn","field_name":"geo_locn_locn","show_question_no":true,"tipo_array":false,"true_alternate_label_str":"Yes","false_alternate_label_str":"No","short_display":true,"disable_expansion":true,"hidden_":true,"hidden_hyperlink":true,"relationship_type":"reference","_ARRAY_META":{"_HASH":"0483370326"}},{"sequence":1009,"display_name___token":"TT___SITE","display_name":"Site","field_type_labels":"Text","field_type":"string","field_name":"site","show_question_no":true,"true_alternate_label_str":"Yes","false_alternate_label_str":"No","read_only":true,"short_display":true,"disable_expansion":true,"hidden_":true,"hidden_hyperlink":true,"relationship_type":"reference","_ARRAY_META":{"_HASH":"7183357080"}},{"sequence":1010,"display_name":"completeActionButtonClick","field_type_labels":"True/False","field_type":"boolean","field_name":"completeactionbuttonclick","show_question_no":true,"true_alternate_label_str":"Yes","false_alternate_label_str":"No","short_display":true,"disable_expansion":true,"hidden_":true,"hidden_hyperlink":true,"relationship_type":"reference","_ARRAY_META":{"_HASH":"7818312925"}}],"tipo_field_groups":[{"tipo_group_name":"geo_locn_locn","tipo_fields":[{"sequence":1,"display_name":"lat","field_type_labels":"Text","field_type":"string","field_name":"lat","show_question_no":true,"true_alternate_label_str":"Yes","false_alternate_label_str":"No","short_display":true,"disable_expansion":true,"hidden_hyperlink":true,"relationship_type":"reference","_ARRAY_META":{"_HASH":"6653105360"}},{"sequence":2,"display_name":"lon","field_type_labels":"Text","field_type":"string","field_name":"lon","show_question_no":true,"true_alternate_label_str":"Yes","false_alternate_label_str":"No","short_display":true,"disable_expansion":true,"hidden_hyperlink":true,"relationship_type":"reference","_ARRAY_META":{"_HASH":"7300078747"}}],"_ARRAY_META":{"_HASH":"0076968443"}}],"tipo_list":{"filters":[{"display_name":"Meetingfilter","hidden_":true,"filter_expression":"parent_tipo_name.keyword: (Meeting)","_ARRAY_META":{"_HASH":"0480156837"}},{"display_name":"MyActionPlan","hidden_":true,"filter_expression":"responsible_person_.keyword:($tipo_context.user_tipo.email)","_ARRAY_META":{"_HASH":"0653278626"}},{"display_name":"Conversationfilter","hidden_":true,"filter_expression":"parent_tipo_name.keyword: (SafetyConversations)","_ARRAY_META":{"_HASH":"0776567053"}},{"display_name":"OperatorRiskFilter","hidden_":true,"filter_expression":"verification_tipo_id_labels:(RiskChecklist) AND responsible_person_.keyword:($tipo_context.user_tipo.email)","_ARRAY_META":{"_HASH":"3079825676"}},{"display_name":"OperatorWPIfilter","hidden_":true,"filter_expression":"verification_tipo_id_labels:(WPIChecklist) AND (responsible_person_.keyword:($tipo_context.user_tipo.email) OR action_reviewer.keyword:($tipo_context.user_tipo.email))","_ARRAY_META":{"_HASH":"4476167515"}},{"display_name":"RiskFilter","hidden_":true,"filter_expression":"verification_tipo_id_labels:(RiskChecklist)","_ARRAY_META":{"_HASH":"5256222347"}},{"display_name":"WPIfilter","hidden_":true,"filter_expression":"verification_tipo_id_labels:(WPIChecklist)","_ARRAY_META":{"_HASH":"6257628062"}},{"display_name":"Incidentfilter","hidden_":true,"filter_expression":"parent_tipo_name.keyword:(CreateIncident)","_ARRAY_META":{"_HASH":"7663941673"}},{"display_name":"OperatorIncidentfilter","hidden_":true,"filter_expression":"parent_tipo_name.keyword:(CreateIncident) AND responsible_person_.keyword:($tipo_context.user_tipo.email)","_ARRAY_META":{"_HASH":"8096604301"}},{"display_name":"Workplanningfilter","hidden_":true,"filter_expression":"verification_tipo_id_labels:(WorkPlanning)","_ARRAY_META":{"_HASH":"8292839085"}}],"multi_filter":true,"sort_fields":[{"sequence":1,"ascending":false,"sort_field":"status_ap.keyword","_ARRAY_META":{"_HASH":"5623218435"}}],"actions":[{"display_name___token":"TT___EXPORT_DATA","display_name":"Export Data","tipo_action":"export_data","highlight":true,"hidden_":true,"javascript_code":"tipoHandle.presentTipoForm('Export data', 'TipoExportDataPlugin', 'view', { tipo: data_handle, hide_actions: true, ___hide_done_action___: true, tipo_handle: this.tipo_handle }, [], false, this.tipoHandleService);\r\nreturn true;","_ARRAY_META":{"_HASH":"5069968521"}},{"display_name___token":"TT___BULK_DELETE","display_name":"Bulk Delete","tipo_action":"bulk_delete","bulk_select":true,"highlight":true,"hidden_":true,"javascript_code":"var count = 0;\n_.forEach(data_handle.selected_tipos, function(each, index){\n    tipoHandle.deleteTipo('CVRMSActionPlan', each.tipo_id).then(function() {\n        count++;\n        if(data_handle.selected_tipos.length == count) {\n            tipoHandle.showMessage('Delete complete successfully');\n            tipoHandle.toTipo('list','CVRMSActionPlan');\n        }\n    });\n\n});","_ARRAY_META":{"_HASH":"7247161328"}}],"desktop_grid":true,"enable_pagination":true,"default_page_size":50,"allow_search":true,"custom_card_template_css":"KiB7IGJveC1zaXppbmc6IGJvcmRlci1ib3g7IH0gYm9keSB7bWFyZ2luOiAwO30="},"tipo_event_js":[{"event_name":"OnList (data_handle)","javascript_code":"if (tipoHandle.tipoInternalHandleService.isOnline) {\r\n    let page = tipoHandle.tipoInternalHandleService.getCurrentState().params && tipoHandle.tipoInternalHandleService.getCurrentState().params.page;\r\n    let filter_str = tipoHandle.tipoInternalHandleService.getCurrentState().url_filter;\r\n        let update_str = filter_str.replace('Task', 'TT___TASK').replace('Εργο', 'TT___TASK').replace('Fixed in Field', 'TT___FIXED_IN_FIELD').replace('Fixed In Field', 'TT___FIXED_IN_FIELD').replace('Διορθώθηκε στο πεδίο', 'TT___FIXED_IN_FIELD').replace('Complete', 'TT___COMPLETE').replace('Πλήρης', 'TT___COMPLETE').replace('Incomplete', 'TT___INCOMPLETE').replace('Ατελής', 'TT___INCOMPLETE').replace('Urgent', 'TT___URGENT').replace('Επείγων', 'TT___URGENT').replace('Medium', 'TT___MEDIUM').replace('Μεσαίο', 'TT___MEDIUM').replace('High', 'TT___HIGH').replace('Υψηλός', 'TT___HIGH').replace('Low', 'TT___LOW').replace('Χαμηλός', 'TT___LOW').replace('Behavioural', 'TT___BEHAVIOURAL').replace('Συμπεριφορικός', 'TT___BEHAVIOURAL').replace('System or Process', 'TT___SYSTEM_OR_PROCESS').replace('Σύστημα ή διαδικασία', 'TT___SYSTEM_OR_PROCESS').replace('Plant or Equipment', 'TT___PLANT_OR_EQUIPMENT').replace('Εργοστάσιο ή εξοπλισμός', 'TT___PLANT_OR_EQUIPMENT');\r\n        console.log(filter_str, update_str);\r\n        tipoHandle.routeTo('/tipo/ActionPlan', { filter: update_str, menu_filter: tipoHandle.tipoInternalHandleService.getCurrentState().url_menu_filter, page: page }, false, true);\r\n}","_ARRAY_META":{"_HASH":"8702550138"}},{"event_name":"OnView (data_handle)","javascript_code":"if (data_handle.mode === 'create') {\r\n    tipoHandle.getTipoParentContext();\r\n    console.log('##Parent##', tipoHandle.getTipoParentContext().value)\r\n    console.log(data_handle)\r\n    data_handle.tipo.geo_locn = tipoHandle.getTipoParentContext().value.tipo.geo_locn;\r\n    // data_handle.tipo.geo_locn_locn = {\r\n    //     'lat' : tipoHandle.getTipoParentContext().value.tipo.geo_locn_location.lat,\r\n    //     'lon' : tipoHandle.getTipoParentContext().value.tipo.geo_locn_location.lon\r\n    // }\r\n    data_handle.tipo.geo_locn_locn = tipoHandle.getTipoParentContext().value.tipo.geo_locn_location;\r\n    data_handle.tipo.structure_level_1_labels = tipoHandle.getTipoParentContext().value.tipo.structure_level_1_labels;\r\n    data_handle.tipo.company_labels = tipoHandle.getTipoParentContext().value.tipo.company_labels;\r\n    data_handle.tipo.contractor_company = tipoHandle.getTipoParentContext().value.tipo.contractor_company_labels;\r\n    \r\n}","_ARRAY_META":{"_HASH":"9030556701"}},{"event_name":"OnSave (data_handle)","javascript_code":"if(data_handle.formControl && !data_handle.formControl.valid) {\n    return;\n}\nif (data_handle.mode === 'create') {\n    if (data_handle.tipo.action_class___token === 'TT___FIXED_IN_FIELD') {\n        const now = new Date(tipoHandle.getDateUtil().utc().format()).toISOString();\n        const time = tipoHandle.getDateUtil().utc().format('HH.mm.sss');\n        const timearray = time.split('.');\n        const dtnumber = (+timearray[0] * 3600) + (+timearray[1] * 60);\n        data_handle.tipo.ap_start_date = now;\n        data_handle.tipo.ap_start_date_dtnumber = dtnumber;\n        data_handle.tipo.end_date = now;\n        data_handle.tipo.end_date_dtnumber = dtnumber;\n        data_handle.tipo.complete_date = now;\n        data_handle.tipo.complete_date_dtnumber = dtnumber;\n    }\n       tipoHandle.getTipo(data_handle.tipo.parent_tipo_name, data_handle.tipo.parent_tipo_id, {}).then((res) => {\n        data_handle.tipo.site_labels = res.site_labels;\n        data_handle.tipo.company_labels = res.company_labels;\n        data_handle.tipo.client_labels = res.client_labels;\n        data_handle.tipo.forwood_level_labels = res.forwood_level_labels;\n        data_handle.tipo.physical_loc_labels = res.physical_loc_labels;\n        data_handle.tipo.action_plan_locn = res.where_incidentlocn;\n        data_handle.tipo.hierarchy_key = res.hierarchy_key;\n        return false;\n})\n }","_ARRAY_META":{"_HASH":"9531591528"}},{"event_name":"PostServerSave (data_handle)","javascript_code":"let completeAction = true;\nlet datahandle_val = data_handle.tipo;\nlet datahandle_response = data_handle.response\nlet user_locale = tipoHandle.user_meta.user_attributes.user.locale\nif (data_handle.formControl && !data_handle.formControl.valid) {\n    return;\n}\ntipoHandle.tipoInternalHandleService.tipoDataService.getTipo('ActionPlan', datahandle_val.tipo_id, {}).subscribe()\n\nif (!datahandle_val.completeactionbuttonclick) {\n    const domain = window.localStorage.getItem('server_url') ? window.localStorage.getItem('server_url') : window.location.origin + '/';\n    const ACTION_LINK = domain + '#/tipo/ActionPlan/' + datahandle_val.tipo_id;\n    const link_url = `<a href=\"` + ACTION_LINK + `\" target=\"_blank\" rel=\"noopener noreferrer\" data-auth=\"NotApplicable\" data-linkindex=\"5\">`\n    const APP_LINK = domain + '#/login';\n    const dt = datahandle_val.end_date;\n    const Date = dt ? tipoHandle.getDateUtil(dt).toString() : '';\n    if (datahandle_val.status_ap___token === 'TT___INCOMPLETE') {\n        var user_filter;\n        var userLang;\n        var framed_template;\n        var templateName;\n        //Notification on create of action plan\n        if (datahandle_response.created_by) {\n            user_filter = `(email.keyword:${datahandle_response.created_by})`;\n            framed_template = 'creatoremail';\n            var created_user = datahandle_response.created_by;\n            sendApEmail(user_filter, framed_template, created_user)\n        }\n\n        //Notification for Reviewer of action plan\n        if (datahandle_val.review && datahandle_val.action_reviewer) {\n            user_filter = `(email.keyword:${datahandle_val.action_reviewer})`\n            framed_template = 'revieweremail';\n            var reviewer_user = datahandle_val.action_reviewer\n            sendApEmail(user_filter, framed_template, reviewer_user)\n\n        }\n\n        // Notification for responsible person\n        if (datahandle_val.notify_responsible_person && datahandle_val.responsible_person_) {\n            user_filter = `(email.keyword:${datahandle_val.responsible_person_})`;\n            framed_template = 'responsibleemail';\n            var responsible_user = datahandle_val.responsible_person_\n            sendApEmail(user_filter, framed_template, responsible_user)\n        }\n\n        function sendApEmail(userfilter, templateString, userval) {\n            templateName = templateString;\n            tipoHandle.getTipos('TipoFIDUser', { tipo_filter: userfilter }, true).then((res) => {\n                userLang = res[0].locale;\n                console.log(\"forwoodUuid\", userLang);\n                tipoHandle.getTipo('EmailTemplates', userLang, {}).then((response) => {\n                    let emailsubject, emailbody;\n                    var ActionClass, ActionType;\n                    let htmlbody = new DOMParser().parseFromString(response.templateName.template.emailbody, 'text/html').body.innerHTML;;\n                    let emailbodydata_converted = htmlbody.replace(/&lt;/g, '<').replace(/&gt;/g, '>')\n                    var compiled_body = _.template(emailbodydata_converted);\n                    if (response.tipo_id != user_locale) {\n                        let translation_filter = `(parent_tipo_id:${datahandle_val.action_class___token} OR ${datahandle_val.action_plan_type___token}) AND (language:${response.tipo_id})`;\n                        tipoHandle.getTipos('TipoSSTranslations', { tipo_filter: translation_filter }, true).then((transval) => {\n                            console.log(\"transval\", transval);\n                            ActionClass = _.find(transval, ['parent_tipo_id', datahandle_val.action_class___token]).translation_value;\n                            ActionType = _.find(transval, ['parent_tipo_id', datahandle_val.action_plan_type___token]).translation_value;\n                            let emailbody_parsed = compiled_body({\n                                'identifier': datahandle_val.tipo_id,\n                                'actioncategory': ActionClass,\n                                'actiontype': ActionType,\n                                'activity': datahandle_val.action_activity,\n                                'duedate': Date,\n                                'actionlink': link_url,\n                                'actionlinkend': '</a>'\n                            });\n                            emailbody = emailbody_parsed.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '\"')\n                            let htmlsubject = new DOMParser().parseFromString(response.templateName.template.emailsubject, 'text/html');\n                            let subjectParsed = htmlsubject.body.textContent;\n                            var compiled_sub = _.template(subjectParsed);\n                            emailsubject = compiled_sub();\n                            sendEmail([userval], emailsubject, `${htmlencode(emailbody)}`);\n                        })\n\n                    }\n                    else {\n                        ActionClass = datahandle_val.action_class;\n                        ActionType = datahandle_val.action_plan_type;\n\n                        let emailbody_parsed = compiled_body({\n                            'identifier': datahandle_val.tipo_id,\n                            'actioncategory': ActionClass,\n                            'actiontype': ActionType,\n                            'activity': datahandle_val.action_activity,\n                            'duedate': Date,\n                            'actionlink': link_url,\n                            'actionlinkend': '</a>'\n                        });\n                        emailbody = emailbody_parsed.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '\"')\n                        let htmlsubject = new DOMParser().parseFromString(response.templateName.template.emailsubject, 'text/html');\n                        let subjectParsed = htmlsubject.body.textContent;\n                        var compiled_sub = _.template(subjectParsed);\n                        emailsubject = compiled_sub();\n                        sendEmail([userval], emailsubject, `${htmlencode(emailbody)}`);\n                    }\n\n\n                })\n            })\n        }\n\n    }\n}\n\n    if (datahandle_val.completeactionbuttonclick) {\n        let datahandle_completeAction = data_handle.tipo;\n        console.log('complete action notification triggered');\n        // Notification complete action\n        const domain = window.localStorage.getItem('server_url') ? window.localStorage.getItem('server_url') : window.location.origin + '/';\n        const ACTION_LINK = domain + '#/tipo/ActionPlan/' + datahandle_completeAction.tipo_id;\n        const APP_LINK = domain + '#/login';\n        const link_url = `<a href=\"` + ACTION_LINK + `\" target=\"_blank\" rel=\"noopener noreferrer\" data-auth=\"NotApplicable\" data-linkindex=\"5\">`\n        let complete_dt = datahandle_completeAction.complete_date;\n        const CDate = complete_dt ? tipoHandle.getDateUtil(complete_dt).toString() : '';\n        let end_date = datahandle_completeAction.end_date;\n        const EDate = end_date ? tipoHandle.getDateUtil(end_date).toString() : '';\n        if (datahandle_completeAction.action_class___token == 'TT___TASK' && datahandle_completeAction.status_ap___token === 'TT___COMPLETE' && !(datahandle_completeAction.ActionCompletedEmailSent)) {\n\n            let users;\n            if (datahandle_completeAction.notify_responsible_person && datahandle_completeAction.review) {\n                users = _.uniq([datahandle_completeAction.responsible_person_, datahandle_completeAction.action_reviewer, datahandle_response.created_by])\n            }\n            else if (datahandle_completeAction.notify_responsible_person) {\n                users = _.uniq([datahandle_completeAction.responsible_person_, datahandle_response.created_by]);\n            }\n            else if (datahandle_completeAction.review) {\n                users = _.uniq([datahandle_completeAction.action_reviewer, datahandle_response.created_by]);\n            }\n            else {\n                users = _.uniq([datahandle_response.created_by]);\n            }\n            if (completeAction) {\n                let user_array = _.map(users, (useremail) => { return '(email.keyword: ' + useremail + ')' });\n                let user_filter = `(${user_array.join(' OR ')})`\n                tipoHandle.getTipos('TipoFIDUser', { tipo_filter: user_filter }, true).then((res) => {\n                    var userln = _.map(res, (list) => {\n                        return {\n                            'email': list.email,\n                            'ln': list.locale\n                        }\n                    })\n                    var userLang = `(tipo_id.keyword:${_.map(userln, 'ln').join(' OR ')})`;\n                    console.log(\"forwoodUuid\", userLang);\n                    tipoHandle.getTipos('EmailTemplates', { tipo_filter: userLang }, true).then((response) => {\n                        console.log(\"Email template\", response)\n                        _.forEach(_.map(userln, 'email'), function (value) {\n                            console.log(value);\n                            var user_ln = _.filter(userln, ['email', value]);\n                            var response_filter = _.filter(response, ['tipo_id', user_ln[0].ln]);\n                            let emailsubject, emailbody;\n                            var ActionClass, ActionType;\n                            let htmlbody = new DOMParser().parseFromString(response_filter[0].completeactionemail.template.emailbody, 'text/html');\n                            let emailbodydata = htmlbody.body.innerHTML;\n                            let emailbodydata_converted = emailbodydata.replace(/&lt;/g, '<').replace(/&gt;/g, '>')\n                            var compiled_body = _.template(emailbodydata_converted);\n                            if (user_ln[0].ln != user_locale) {\n                                let translation_filter = `(parent_tipo_id:${datahandle_completeAction.action_class___token} OR ${datahandle_completeAction.action_plan_type___token}) AND (language:${user_ln[0].ln})`\n                                tipoHandle.getTipos('TipoSSTranslations', { tipo_filter: translation_filter }, true).then((transval) => {\n                                    console.log(\"transval\", transval);\n                                    ActionClass = _.find(transval, ['parent_tipo_id', datahandle_completeAction.action_class___token]).translation_value;\n                                    ActionType = _.find(transval, ['parent_tipo_id', datahandle_completeAction.action_plan_type___token]).translation_value;\n                                    let emailbody_parsed = compiled_body({\n                                        'identifier': datahandle_completeAction.tipo_id,\n                                        'actioncategory': ActionClass,\n                                        'actiontype': ActionType,\n                                        'activity': datahandle_completeAction.action_activity,\n                                        'duedate': EDate,\n                                        'actionlink': link_url,\n                                        'actionlinkend': '</a>'\n                                    });\n                                    emailbody = emailbody_parsed.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '\"')\n                                    let htmlsubject = new DOMParser().parseFromString(response_filter[0].completeactionemail.template.emailsubject, 'text/html');\n                                    let subjectParsed = htmlsubject.body.textContent;\n                                    var compiled_sub = _.template(subjectParsed);\n                                    emailsubject = compiled_sub();\n                                    sendEmail([value], emailsubject, `${htmlencode(emailbody)}`);\n                                })\n                            }\n                            else {\n                                ActionClass = datahandle_completeAction.action_class;\n                                ActionType = datahandle_completeAction.action_plan_type;\n                                let emailbody_parsed = compiled_body({\n                                    'identifier': datahandle_completeAction.tipo_id,\n                                    'actioncategory': ActionClass,\n                                    'actiontype': ActionType,\n                                    'activity': datahandle_completeAction.action_activity,\n                                    'duedate': EDate,\n                                    'actionlink': link_url,\n                                    'actionlinkend': '</a>'\n                                });\n                                emailbody = emailbody_parsed.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '\"')\n                                let htmlsubject = new DOMParser().parseFromString(response_filter[0].completeactionemail.template.emailsubject, 'text/html');\n                                let subjectParsed = htmlsubject.body.textContent;\n                                var compiled_sub = _.template(subjectParsed);\n                                emailsubject = compiled_sub();\n                                sendEmail([value], emailsubject, `${htmlencode(emailbody)}`);\n                            }\n\n\n                        });\n                    })\n                })\n            }\n            completeAction = false;\n            datahandle_completeAction.ActionCompletedEmailSent = true;\n            tipoHandle.updateTipo('ActionPlan', datahandle_completeAction.tipo_id, datahandle_completeAction).then((result) => {\n                console.log(\"data_handle\", datahandle_completeAction)\n\n            })\n        }\n    }\n    function htmlencode(str) {\n        let escape_encoder = /<[^<>]+>|./g\n        return str.replace(escape_encoder, function (r) {\n            return r[0] == '<' ? r : r[0] == '$' ? '' : \"&#\" + r[0].charCodeAt() + \";\"\n        });\n    }\n\n    function sendEmail(users, subject, body) {\n        console.log(users, subject, body);\n        const recipents_limit = 50;\n        var a = _.uniq(users);\n        while (a.length) {\n            let recipents = a.splice(0, recipents_limit);\n            console.log(recipents.toString());\n            tipoHandle.sendEmail(recipents.toString(), subject, body);\n        }\n    }\nreturn true;","_ARRAY_META":{"_HASH":"9671091778"}}],"custom_template_css":"KiB7IGJveC1zaXppbmc6IGJvcmRlci1ib3g7IH0gYm9keSB7bWFyZ2luOiAwO30=","custom_template_config":"W10=","updated_dt":1725536519573,"updated_by_labels":"indrayani rahangdale","updated_date":"2024-09-05T11:41:59.573Z","created_by":"saadmin@forwoodsafety.com","created_dt":"1628059813034","created_date":"2021-08-04T06:50:13.034Z","application_owner_account":"2000000001","account":"2000000001","tipo_name":"TipoDefinition","hash_key":"2000000001.0443429762.2000000001.TipoDefinition.ActionPlan","updated_by":"devops@forwoodsafety.com","el_index":true}}
